<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>A simple example with litescene.js</title>
    <style type='text/css'>
		html, body { width: 100%; height: 100%; overflow: hidden; }
		* { margin: 0; padding: 0; }
	  </style>
    <script src="./js/third_party/litescene.js/externals/gl-matrix-min.js"></script>
    <script src="./js/third_party/litescene.js/externals/litegl.min.js"></script>
    <script src="./js/third_party/litescene.js/externals/litegraph.min.js"></script>
    <script src="./js/third_party/litescene.js/litescene.js"></script>
    <script async src="../build/artoolkit.min.js"></script>
    <script type="text/javascript">
    var i = 3;

    var APP = {
		cam_dist: 10,

    ar: {transform: []},

		init: function()
		{
			//create the GL context
			try
			{
				gl = GL.create({alpha:false, premultipliedAlpha: false });
			}
			catch (e)
			{
				alert("WebGL not supported by your browser");
				return;
			}

			//resize the canvas and add to DOM
      var width = 640;
      var height = 480;
      gl.canvas.width = width;
      gl.canvas.height = height;
			this.glcanvas = gl.canvas;
      document.getElementById('app').appendChild(gl.canvas);
			this.gl = gl;

      //capture interaction events
			gl.ondraw = this.ondraw;
			gl.onupdate = this.onupdate;
			gl.animate();

			//prepare LiteScene
			LS.Renderer.init();

			//scene globals
			LS.GlobalScene.info.background_color = [0.1,0.1,0.1,1];
			LS.GlobalScene.info.ambient_color = [0.2,0.2,0.2];

			//global camera
      var camera = new LS.Camera();
      camera.clear_color = true;
      camera.background_color = [0, 0, 0, 1];
			camera.center = [0,0,0];
			camera.eye = [0,100,100];
			camera.far = 1000;
			camera.near = 0.1;
      camera.up = [0, 1, 0];
      camera.fov = 45;
      camera.viewport = [0, 0, 1, 1];
      var nodeCam = new LS.SceneNode("cameraNode");
      nodeCam.addComponent(camera);
      LS.GlobalScene.root.addChild( nodeCam );

      // add a simple cube and attach it to a node
      var node = new LS.SceneNode(); //create a node
      LS.GlobalScene.root.addChild( node ); //add to the scene
      var mesh = GL.Mesh.cube({size: 1}); // add a simple cube with size of 1
      var comp = new LS.Components.MeshRenderer({mesh: mesh }); //create a mesh renderer
      node.addComponent( comp ); //add to the node
      node.material =  new LS.StandardMaterial({ color: [0.5,0.5,0.5] });

      var arController;
      var transform;
      var interval = setTimeout(function() {

      arController = new ARController(640, 480, 'Data/camera_para.dat');

      var camera_mat = arController.getCameraMatrix();

      if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        var hint = {
            audio: false,
            video: true
        };
        if( window.innerWidth < 800 ) {
            var width = ( window.innerWidth < window.innerHeight ) ? 240 : 320;
            var height = ( window.innerWidth < window.innerHeight ) ? 320 : 240;

            var aspectRatio = window.innerWidth / window.innerHeight;

            console.log( width, height );

            hint = {
                audio: false,
                video: {
                    facingMode: 'environment',
                    width: { min: width, max: width }
                },
            };

            console.log( hint );
        }

        navigator.mediaDevices.getUserMedia( hint ).then( function( stream ) {
            video.srcObject = stream;
            video.addEventListener( 'loadedmetadata', function() {
                video.play();

                console.log( 'video', video, video.videoWidth, video.videoHeight );
                  } );

                  arController.loadMarker('Data/patt.hiro', function(markerId){
                    console.log("loadMarker -> ", markerId);
                    arController.trackPatternMarkerId(markerId);

                  });

                  var interval = setInterval(function() {
                    arController.process(video);
                  }, 13);

                  var markerNum = arController.getMarkerNum();
                  arController.addEventListener('getMarker', function(ev) {
                    transform =  ev.data.matrix;
                    console.log("Marker data", transform);
                  });

                  if(transform){
                    let cameraGlobalMatrix = nodeCam.transform.getGlobalMatrix();
                    let markerRootMatrix = mat4.create();;
                    mat4.multiply(markerRootMatrix, cameraGlobalMatrix, transform);
                    let outQuat = quat.create();
                    quat.fromMat4(outQuat,markerRootMatrix);
                    outQuat[0]*=-1;
                    var markerRoot = LS.GlobalScene.root
                    markerRoot.transform.setPosition(vec3.fromValues(markerRootMatrix[12],markerRootMatrix[13]*-1,markerRootMatrix[14]*-1));
                    markerRoot.transform.setRotation(outQuat);
              			LS.GlobalScene.update(dt);
                  }
              } );
          }
      }, 200);

      LS.GlobalScene.refresh();

		},

    ondraw: function()
		{
			//setup the camera
			//var camera = LS.GlobalScene.getCamera();
			//camera.eye = [5 * (APP.cam_dist),40, -20 * (APP.cam_dist)];
			//render the scene (it uses LS.GlobalScene as default)
			LS.Renderer.render();
		},

		onupdate: function(dt)
		{
			var now = new Date().getTime();

			LS.GlobalScene.update(dt);
		},

	}

      </script>
  </head>
  <body>
    <div id="app">
        <video
            loop
            autoplay
            muted
            playsinline
            id="video">
        </video>

        <!--<canvas id="canvas"></canvas>-->
    </div>
      <script>
            APP.init();
    </script>
  </body>
</html>
