<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>A simple example with litescene.js</title>
    <style type='text/css'>
		html, body { width: 100%; height: 100%; overflow: hidden; }
		* { margin: 0; padding: 0; }
	  </style>
    <script src="./js/third_party/litescene.js/externals/gl-matrix-min.js"></script>
    <script src="./js/third_party/litescene.js/externals/litegl.min.js"></script>
    <script src="./js/third_party/litescene.js/externals/litegraph.min.js"></script>
    <script src="./js/third_party/litescene.js/litescene.js"></script>
    <script async src="../build/artoolkit.min.js"></script>
    <script type="text/javascript">

      var APP = {
		cam_dist: 10,
    ar: {},

		init: function()
		{
			//create the GL context
			try
			{
				gl = GL.create({alpha:false, premultipliedAlpha: false });
			}
			catch (e)
			{
				alert("WebGL not supported by your browser");
				return;
			}

			//resize the canvas and add to DOM
      var width = 640;
      var height = 480;
      gl.canvas.width = width;
      gl.canvas.height = height;
			this.glcanvas = gl.canvas;
			document.body.appendChild(gl.canvas);
			this.gl = gl;

      //capture interaction events
			gl.ondraw = this.ondraw;
			gl.onupdate = this.onupdate;
			gl.animate();

			//prepare LiteScene
			LS.Renderer.init();

			//scene globals
			LS.GlobalScene.info.background_color = [0.1,0.1,0.1,1];
			LS.GlobalScene.info.ambient_color = [0.2,0.2,0.2];

			//global camera
			var camera = LS.GlobalScene.getCamera();
			camera.center = [0,35,0];
			camera.eye = [150,40,150];
			camera.far = 1000;
			camera.near = 1;

      // add a simple cube and attach it to a node
      var node = new LS.SceneNode(); //create a node
      LS.GlobalScene.root.addChild( node ); //add to the scene
      var mesh = GL.Mesh.cube({size: 10}); // add a simple cube with size of 10
      var comp = new LS.Components.MeshRenderer({mesh: mesh}); //create a mesh renderer
      node.addComponent( comp ); //add to the node
      //console.log(node.transform);

      var arController;
      var interval = setTimeout(function() {

      arController = new ARController(640, 480, 'Data/camera_para.dat');
      APP.ar = arController;
      //console.log(APP.ar)

      var camera_mat = arController.getCameraMatrix();
      camera.setCustomProjectionMatrix = camera_mat;

      if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        var hint = {
            audio: false,
            video: true
        };
        if( window.innerWidth < 800 ) {
            var width = ( window.innerWidth < window.innerHeight ) ? 240 : 360;
            var height = ( window.innerWidth < window.innerHeight ) ? 360 : 240;

            var aspectRatio = window.innerWidth / window.innerHeight;

            console.log( width, height );

            hint = {
                audio: false,
                video: {
                    facingMode: 'environment',
                    width: { min: width, max: width }
                },
            };

            console.log( hint );
        }

        navigator.mediaDevices.getUserMedia( hint ).then( function( stream ) {
            video.srcObject = stream;
            video.addEventListener( 'loadedmetadata', function() {
                video.play();

                console.log( 'video', video, video.videoWidth, video.videoHeight );
                  } );

                  arController.loadMarker('Data/patt.hiro', function(markerId){
                    console.log(markerId >= 0, "Marker loaded");
                    arController.trackPatternMarkerId(markerId);
                    //arController.process(video);
                  });
                  arController.process(video);
                	var markerNum = arController.getMarkerNum();

                	if (markerNum > 0) {
                		if (node.transform.visible) {
                			arController.getTransMatSquareCont(0, 1, node.transform.matrix, node.transform.matrix);
                		} else {
                			arController.getTransMatSquare(0 /* Marker index */, 1 /* Marker width */, node.transform.matrix);
                		}
                		root.visible = true;
                    arController.arglCameraViewRHf(arController.transMatToGLMat(node.transform.matrix), node.transform.matrix.elements);

                	} else {
                		node.transform.visible = false;
                	}
              } );
          }
      }, 200);
			//example of forward render function to inject draw calls into the scene
			LS.Renderer.onRenderScene = function(camera)
			{
			//not needed in this case
			}

		},

    ondraw: function()
		{
			//setup the camera
			var camera = LS.GlobalScene.getCamera();
			camera.eye = [5 * (APP.cam_dist),40, -20 * (APP.cam_dist)];
			//render the scene (it uses LS.GlobalScene as default)
			LS.Renderer.render();
      //this not works, i get APP.ar.addEventListener is not a function
      //APP.ar.addEventListener('getMarker', function(ev) {
      //  console.log("Marker data", ev.data.marker);
      //});
		},

		onupdate: function(dt)
		{
			var now = new Date().getTime();
			LS.GlobalScene.update(dt);
		},

	}

      </script>
  </head>
  <body>
    <div id="app">
        <video
            loop
            autoplay
            muted
            playsinline
            id="video">
        </video>

        <canvas id="canvas"></canvas>
    </div>
      <script>APP.init();</script>
  </body>
</html>
